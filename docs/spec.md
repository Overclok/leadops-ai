# Spec — LeadOps AI (Italia/EU)

## Frozen Scope (Deterministic)
- **Lead Definition**: Cold email outreach + Inbound inquiries.
- **Channels**:
  - Gmail (replies detection)
  - Calendly (booking events)
  - Twilio / Vapi (voice calls)
- **User Model**: Single user per tenant (Clerk Auth).
- **Core Loop**: Provider -> n8n -> Webhook Ingestion -> Event Store -> Metrics -> Dashboard.

## Assumptions
- Supabase is the implementation of the Event Store.
- n8n is the exclusive adapter for all 3rd party providers.
- All events are append-only; state is derived.
- `EMAIL_NO_REPLY` is a derived event generated by a scheduled process, not a provider.

## Non-Goals (v1)
- Multi-user RBAC within a tenant.
- Frontend creation/editing of campaigns (read-only dashboard).
- Complex CRM features (notes, tasks management).
- Direct provider integration in Next.js (bypass n8n).

## Blocking Questions
*(None at this stage. Spec is frozen.)*

## Architettura
Provider → n8n (adapter) → `/api/events` (Next) → Supabase (event store) → API metrics → dashboard.

## Local run (dev)
1) Supabase: crea progetto, esegui `infra/supabase/migrations/001_init.sql`
2) Clerk: crea app, configura env in `apps/web/.env.example`
3) Web: `cd apps/web && npm install && npm run dev`
4) n8n: `cd infra/n8n && docker compose up -d`
5) Import workflow JSON in n8n e set env: `AG_API_BASE`, `AG_TENANT_ID`, `AG_WEBHOOK_SECRET`.

## Integration Notes

### Clerk Auth & Tenant Model (Agent A3)
**Implementation Status**: ✅ Integrated (2026-01-22)

**Model**: Strict 1-user-per-tenant architecture.
- Each Clerk user (`userId`) maps to exactly **one** tenant in Supabase.
- Tenant auto-creation on first login via `getOrCreateTenant()`.
- No Clerk Organizations used (enforcing single-user ownership).

**Middleware**:
- File: `apps/web/src/proxy.ts` (Next.js 16 renamed middleware → proxy)
- Protected routes: `/dashboard`, `/api/tenant`, `/api/metrics`, `/api/internal`
- Public routes: `/api/events` (webhook ingestion, validated via HMAC)
- Uses `clerkMiddleware` with `createRouteMatcher` for deterministic route protection.

**Tenant Resolution**:
- File: `apps/web/src/lib/tenant.ts`
- Function: `getOrCreateTenant()` → Returns `{ id, owner_clerk_user_id, name, webhook_secret, created_at }`
- Function: `getTenantId()` → Returns `string` (tenant UUID)
- Function: `assertTenantOwnership(resourceTenantId)` → Throws if cross-tenant access detected

**Cross-Tenant Prevention**:
- Runtime assertions via `assertTenantOwnership(resourceTenantId)`.
- All queries must filter by `tenant_id` from current auth context.
- RLS policies in Supabase deny direct access (use service role with tenant_id filtering).

**Environment Variables** (Clerk):
```bash
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
```

**Tests**:
- Location: `apps/web/src/lib/__tests__/tenant.test.ts`
- Conceptual unit tests for tenant creation and cross-tenant protection logic.
