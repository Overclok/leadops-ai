# Event contracts

## Canonical Source
The single source of truth for the event schema is:
`/.agent/skills/metrics-engine/references/event-schema.json`

## Ingestion Protocol

### Headers
Requests to `/api/events` must include:
- `tenant-id`: UUID of the tenant.
- `timestamp`: ISO 8601 or epoch ms (used for signature window).
- `event-id`: Deterministic ID of the event.
- `signature`: `hex(HMAC_SHA256(secret, timestamp + "." + stableStringify(event)))`

### Deterministic Event Identity (`event_id`)
Providers must generate stable IDs to ensure idempotency.

| Event Type | `event_id` Pattern | Source |
| :--- | :--- | :--- |
| **Gmail Sent** | `evt_gmail_sent_<messageId>` | Gmail / n8n |
| **Gmail Reply** | `evt_gmail_reply_<threadId>_<messageId>` | Gmail / n8n |
| **Cal Booked** | `evt_cal_booked_<eventUuid>` | Calendly / n8n |
| **Vapi Call** | `evt_vapi_call_<callId>_<direction>` | Vapi / n8n |

`direction` for Vapi: `inbound` or `outbound`.

## Derived Events
- **EMAIL_NO_REPLY**: Generated by the system 5 days after `EMAIL_SENT` if no `EMAIL_REPLIED` occurs.
- **Sources**:
  - `system`: for internal logic (like derived events).
  - `n8n`: for all external providers.

## Stability
`stableStringify` must sort object keys lexicographically before signing. See `apps/web/src/lib/stableJson.ts`.
