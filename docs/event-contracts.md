# Event contracts

## Canonical Source
The single source of truth for the event schema is:
`/.agent/skills/metrics-engine/references/event-schema.json`

## Ingestion Protocol
1. **Signature**:
   - Header `x-ag-ts`: current epoch ms.
   - Header `x-ag-signature`: `hex(HMAC_SHA256(secret, ts + "." + stableStringify(event)))`
2. **Idempotency**:
   - DB enforces unique `(tenant_id, idempotency_key)`.
   - Providers must generate stable keys (e.g., MessageID, CallSID).

## Derived Events
- **EMAIL_NO_REPLY**: Generated by the system 5 days after `EMAIL_SENT` if no `EMAIL_REPLIED` occurs.
- **Sources**:
  - `system`: for internal logic (like derived events).
  - `n8n`: for all external providers.

## Stability
`stableStringify` must sort object keys lexicographically before signing. See `apps/web/src/lib/stableJson.ts`.
